#!/usr/bin/env python3
import datetime
import os
import subprocess
import sys

import requests

BASE = os.path.expanduser("~/WANSTAGE")
LOG_FILE = os.path.join(BASE, "logs", "auto_intel_gen.log")
PHASE3 = "--phase=3" in sys.argv

def log(msg):
    ts = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"[{ts}] {msg}")
    with open(LOG_FILE, "a") as f:
        f.write(f"[{ts}] {msg}\n")

def slack_notify(text, emoji="ğŸ§ "):
    url = os.environ.get("SLACK_WEBHOOK_URL")
    if not url:
        log("âš  SLACK_WEBHOOK_URL æœªè¨­å®šï¼ˆé€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼‰")
        return
    try:
        requests.post(url, json={"text": f"{emoji} *WANSTAGE_AUTO_INTEL_GEN*: {text}"}, timeout=5)
        log(f"ğŸ“¤ Slacké€šçŸ¥é€ä¿¡: {text}")
    except Exception as e:
        log(f"âŒ Slacké€šçŸ¥å¤±æ•—: {e}")

def pm2_register(name, path, cron="*/10 * * * *"):
    cmd = f'''pm2 delete {name} 2>/dev/null || true
pm2 start "bash -lc 'source {BASE}/.env; bash {path}'" --name {name} --cron "{cron}"
pm2 save'''
    subprocess.run(cmd, shell=True, check=False)
    log(f"âš™ï¸ PM2ç™»éŒ²å®Œäº†: {name} ({path})")

def main():
    log("ğŸš€ AUTO_INTEL_GEN Phase 3 started")
    slack_notify("Phase 3 è‡ªå‹•ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸ")

    targets = [
        ("auto_macro_gen", f"{BASE}/core/auto_macro_gen.sh"),
        ("auto_patch_ui", f"{BASE}/core/auto_patch_ui.sh")
    ]

    for name, path in targets:
        if os.path.exists(path):
            pm2_register(name, path)
            slack_notify(f"{name} ã‚’PM2ç™»éŒ²ã—ã¾ã—ãŸ âœ…")
        else:
            log(f"âš  ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {path}")

    slack_notify("Phase 3 è‡ªå‹•åŒ–å‡¦ç† å®Œäº† ğŸ‰")
    log("ğŸ AUTO_INTEL_GEN Phase 3 å®Œäº†")

if __name__ == "__main__":
    main()


# == PHASE 4: WANSTAGE_SELF_HEAL SYSTEM ==
elif args.phase == '4':
    import datetime
    import os
    import pathlib
    import subprocess
    print('[%s] ğŸš€ AUTO_INTEL_GEN Phase 4 started' % datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
    base = os.path.expanduser('~/WANSTAGE')
    script = f"{base}/bin/wan-autoheal-full.sh"
    if not pathlib.Path(script).exists():
        print('âš  è‡ªå‹•ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', script)
    else:
        subprocess.run(['chmod','+x',script], check=False)
        subprocess.run(['pm2','start',script,'--name','wan-autoheal-full'], check=False)
        subprocess.run(['pm2','save'], check=False)
        print('[%s] âš™ï¸ PM2ç™»éŒ²å®Œäº†: wan-autoheal-full (%s)' % (datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'), script))
    print('[%s] âœ… Slacké€šçŸ¥çµ±åˆæ¸ˆã¿' % datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
    print('[%s] âœ… ãƒ­ã‚°ç›£è¦–: ~/WANSTAGE/logs/autoheal.log' % datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
    print('[%s] ğŸ AUTO_INTEL_GEN Phase 4 å®Œäº†' % datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
# == END PHASE 4 ==
