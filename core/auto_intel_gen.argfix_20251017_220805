#!/usr/bin/env python3
import datetime
import os
import subprocess
import sys

import requests

BASE = os.path.expanduser("~/WANSTAGE")
LOG_FILE = os.path.join(BASE, "logs", "auto_intel_gen.log")
PHASE3 = "--phase=3" in sys.argv

def log(msg):
    ts = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"[{ts}] {msg}")
    with open(LOG_FILE, "a") as f:
        f.write(f"[{ts}] {msg}\n")

def slack_notify(text, emoji="ğŸ§ "):
    url = os.environ.get("SLACK_WEBHOOK_URL")
    if not url:
        log("âš  SLACK_WEBHOOK_URL æœªè¨­å®šï¼ˆé€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼‰")
        return
    try:
        requests.post(url, json={"text": f"{emoji} *WANSTAGE_AUTO_INTEL_GEN*: {text}"}, timeout=5)
        log(f"ğŸ“¤ Slacké€šçŸ¥é€ä¿¡: {text}")
    except Exception as e:
        log(f"âŒ Slacké€šçŸ¥å¤±æ•—: {e}")

def pm2_register(name, path, cron="*/10 * * * *"):
    cmd = f'''pm2 delete {name} 2>/dev/null || true
pm2 start "bash -lc 'source {BASE}/.env; bash {path}'" --name {name} --cron "{cron}"
pm2 save'''
    subprocess.run(cmd, shell=True, check=False)
    log(f"âš™ï¸ PM2ç™»éŒ²å®Œäº†: {name} ({path})")

def main():
    log("ğŸš€ AUTO_INTEL_GEN Phase 3 started")
    slack_notify("Phase 3 è‡ªå‹•ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸ")

    targets = [
        ("auto_macro_gen", f"{BASE}/core/auto_macro_gen.sh"),
        ("auto_patch_ui", f"{BASE}/core/auto_patch_ui.sh")
    ]

    for name, path in targets:
        if os.path.exists(path):
            pm2_register(name, path)
            slack_notify(f"{name} ã‚’PM2ç™»éŒ²ã—ã¾ã—ãŸ âœ…")
        else:
            log(f"âš  ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {path}")

    slack_notify("Phase 3 è‡ªå‹•åŒ–å‡¦ç† å®Œäº† ğŸ‰")
    log("ğŸ AUTO_INTEL_GEN Phase 3 å®Œäº†")

if __name__ == "__main__":
    main()
