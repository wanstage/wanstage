#!/usr/bin/env bash
set -euo pipefail
BASE="$HOME/WANSTAGE"; LOGS="$BASE/logs"; mkdir -p "$LOGS"
log(){ echo "[$(date '+%F %T')] $*" | tee -a "$LOGS/full_auto.log"; }

# 環境変数読み込み
if [ -f "$BASE/.env" ]; then set -a; . "$BASE/.env"; set +a; fi

# 1) コンテンツ生成
log "Generate post..."
python3 "$BASE/generate_post_from_prompt.py" >> "$LOGS/full_auto.log" 2>&1 || true
python3 "$BASE/generate_post_from_prompt.py" >> "$LOGS/full_auto.log" 2>&1 || log "generate_post fallback (skipped errors)"

POST_TEXT_PATH="$LOGS/post_text.txt"
if [ ! -s "$POST_TEXT_PATH" ]; then echo "テンプレ投稿" > "$POST_TEXT_PATH"; fi
POST_TEXT="$(cat "$POST_TEXT_PATH")"

# 任意：画像/動画URL（Zapier等で利用）。未設定なら空のままOK
IMAGE_URL="${POST_IMAGE_URL:-}"
VIDEO_URL="${POST_VIDEO_URL:-}"

# 2) 配信（Webhook方式：最短で動く）
post_webhook(){
  local url="$1"; local platform="$2"
  curl -s -X POST -H "Content-Type: application/json" \
    -d "$(jq -n --arg text "$POST_TEXT" --arg img "$IMAGE_URL" --arg vid "$VIDEO_URL" \
          '{text:$text, image_url:$img, video_url:$vid, platform:"'$platform'"}')" \
    "$url" >> "$LOGS/full_auto.log" 2>&1 || true
  log "posted via webhook -> $platform"
}

# jq が無ければ簡易JSONで代替
jq --version >/dev/null 2>&1 || post_webhook(){ local url="$1"; local platform="$2"; curl -s -X POST -H "Content-Type: application/json" \
  -d "{\"text\":$(python3 -c 'import json,sys;print(json.dumps(sys.argv[1]))' "$POST_TEXT"),\"image_url\":\"$IMAGE_URL\",\"video_url\":\"$VIDEO_URL\",\"platform\":\"$platform\"}" \
  "$url" >> "$LOGS/full_auto.log" 2>&1 || true; log "posted via webhook -> $platform"; }

# --- Webhook 環境変数があれば順次投稿 ---
[ -n "${WEBHOOK_INSTAGRAM:-}" ] && post_webhook "$WEBHOOK_INSTAGRAM" "instagram"
[ -n "${WEBHOOK_YOUTUBE:-}"   ] && post_webhook "$WEBHOOK_YOUTUBE"   "youtube"
[ -n "${WEBHOOK_X:-}"         ] && post_webhook "$WEBHOOK_X"         "x"
[ -n "${WEBHOOK_TIKTOK:-}"    ] && post_webhook "$WEBHOOK_TIKTOK"    "tiktok"

# 3) Slack通知
if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
  curl -s -X POST -H 'Content-type: application/json' \
    --data "{\"text\":\"✅ Auto-post done: $(date '+%F %T')\\n$(echo "$POST_TEXT" | head -n 3) ...\"}" \
    "$SLACK_WEBHOOK_URL" >> "$LOGS/full_auto.log" 2>&1 || true
  log "notified Slack"
fi

# 4) LINE通知（Zapier/Make のキャッチURL想定）
if [ -n "${ZAPIER_LINE_HOOK:-}" ]; then -o /dev/null
  curl -s -X POST "$ZAPIER_LINE_HOOK" \ -o /dev/null -o /dev/null
    -d "message=✅ Auto-post done: $(date '+%F %T')" >> "$LOGS/full_auto.log" 2>&1 || true
  log "notified LINE (Zapier)"
fi

echo "[OK] full_auto_post_flow finished: $(date '+%F %T')" >> "$LOGS/cron.log"
log "done."
