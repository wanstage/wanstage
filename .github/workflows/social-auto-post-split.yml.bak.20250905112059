name: social-auto-post-split

on:
  schedule:
    # å¹³æ—¥ 09:00 JSTï¼ˆUTC 00:00ï¼‰
    - cron: '0 0 * * 1-5'
    # å¹³æ—¥ 18:00 JSTï¼ˆUTC 09:00ï¼‰
    - cron: '0 9 * * 1-5'
    # é€±æœ« 10:00 JSTï¼ˆUTC 01:00ï¼‰
    - cron: '0 1 * * 6,0'
  workflow_dispatch:
    inputs:
      to:
        description: 'æŠ•ç¨¿å…ˆï¼ˆç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¡Œå…ˆãƒãƒˆãƒªã‚¯ã‚¹ã‚’ä½¿ç”¨ï¼‰'
        required: false
        default: ''
        type: choice
        options: ['', bluesky, mastodon]
      message:
        description: 'æŠ•ç¨¿æœ¬æ–‡ï¼ˆç©ºãªã‚‰æ—¢å®šæ–‡ã‚’è‡ªå‹•ç”Ÿæˆï¼‰'
        required: false
        default: ''
      image:
        description: 'ç”»åƒURLï¼ˆZapierå´ãŒURLå—å–å¯¾å¿œã®å ´åˆï¼‰'
        required: false
        default: ''
      dateprefix:
        description: 'æ–‡é ­ã«æ—¥ä»˜ï¼ˆJSTï¼‰ã‚’ä»˜ä¸'
        required: false
        default: true
        type: boolean
      hashtags:
        description: 'ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š: wanstage,test ã®ã‚ˆã†ã«'
        required: false
        default: ''

env:\n  TEMPLATE_MORNING: "â˜€ï¸ ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã®WANSTAGEã¯â€¦"\n  TEMPLATE_EVENING: "ğŸŒ™ å¤•æ–¹ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼é€²æ—ã¾ã¨ã‚:"\n  TEMPLATE_WEEKEND: "ğŸ‰ é€±æœ«ã‚¹ãƒšã‚·ãƒ£ãƒ«ï¼ãŠã™ã™ã‚ã¯â€¦"\n\njobs:\n  post:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        to: [bluesky, mastodon]
    # æ‰‹å‹•: toæœªæŒ‡å®šãªã‚‰ä¸¡æ–¹ã€‚æŒ‡å®šæ™‚ã¯ä¸€è‡´ã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.inputs.to == '' || github.event.inputs.to == matrix.to }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - run: npm ci

      - name: Derive slot label
        id: slot
        shell: bash
        run: |
          # UTCæ™‚åˆ»ã§åˆ†å²ã—ã¦ã€Œã©ã®ã‚¹ãƒ­ãƒƒãƒˆã‹ã€ã‚’åˆ¤å®šï¼ˆãƒ­ã‚°/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è£…é£¾ç”¨ï¼‰
          H=$(date -u +'%H')
          DOW=$(date -u +'%u') # 1..7 (Mon..Sun)
          # JST 09:00 = UTC 00:00ã€JST 18:00 = UTC 09:00ã€JST åœŸæ—¥10:00 = UTC 01:00
          if [[ "$DOW" -ge 1 && "$DOW" -le 5 && "$H" == "00" ]]; then
            echo "slot=wk-0900" >> $GITHUB_OUTPUT
          elif [[ "$DOW" -ge 1 && "$DOW" -le 5 && "$H" == "09" ]]; then
            echo "slot=wk-1800" >> $GITHUB_OUTPUT
          elif [[ "$DOW" -eq 6 || "$DOW" -eq 7 ]] && [[ "$H" == "01" ]]; then
            echo "slot=we-1000" >> $GITHUB_OUTPUT
          else
            echo "slot=manual" >> $GITHUB_OUTPUT
          fi

      - name: Post via Zapier relay
        env:
          ZAPIER_HOOK_URL: ${{ secrets.ZAPIER_HOOK_URL }}
          DEFAULT_HASHTAGS: ${{ vars.DEFAULT_HASHTAGS }}
          PROMO_URL: ${{ vars.PROMO_URL }}
        shell: bash
        run: |
          set -euo pipefail

          # 1) ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆï¼ˆå…¥åŠ›ãŒç©ºãªã‚‰æ ã‚’è‡ªå‹•çµ„ç«‹ï¼‰
          MSG="${{ github.event.inputs.message }}"
HOUR=$(date -u +"%H")
DOW=$(date -u +"%u")
if [ -z "$MSG" ]; then
  if [ "$DOW" -ge 6 ]; then MSG="$TEMPLATE_WEEKEND";
  elif [ "$HOUR" -lt 9 ]; then MSG="$TEMPLATE_MORNING";
  else MSG="$TEMPLATE_EVENING"; fi
fi
          if [ -z "${MSG}" ]; then
            SLOT="${{ steps.slot.outputs.slot }}"
            CASE="$SLOT"
            case "$CASE" in
              wk-0900)  PREFIX="ã€æœã®æ›´æ–°ã€‘";;
              wk-1800)  PREFIX="ã€å¤•æ–¹ã®æ›´æ–°ã€‘";;
              we-1000)  PREFIX="ã€é€±æœ«ã®æ›´æ–°ã€‘";;
              *)        PREFIX="";;
            esac
            MSG="${PREFIX} å®šæœŸæŠ•ç¨¿ $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          fi

          # 2) ä»˜ä¸è¦ç´ ï¼ˆprefix / ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚° / ç”»åƒï¼‰
          ARGS="--to=${{ matrix.to }}"
          if [ "${{ github.event.inputs.dateprefix }}" = "true" ]; then
            ARGS="$ARGS --dateprefix"
          fi

          # åç›Šå°ç·š: ãƒ—ãƒ­ãƒ¢URLï¼ˆã‚ã‚Œã°æœ¬æ–‡æœ«å°¾ã«ä»˜ä¸ï¼‰
          if [ -n "${PROMO_URL:-}" ]; then
            MSG="$MSG ${PROMO_URL}"
          fi

          if [ -n "${{ github.event.inputs.hashtags }}" ]; then
            ARGS="$ARGS --hashtags=${{ github.event.inputs.hashtags }}"
          elif [ -n "${DEFAULT_HASHTAGS:-}" ]; then
            ARGS="$ARGS --hashtags=${DEFAULT_HASHTAGS}"
          fi

          if [ -n "${{ github.event.inputs.image }}" ]; then
            ARGS="$ARGS --image=${{ github.event.inputs.image }}"
          fi

          echo "node --no-warnings --experimental-strip-types ./src/post.ts $ARGS \"$MSG\""
          node --no-warnings --experimental-strip-types ./src/post.ts $ARGS "$MSG"
