name: social-auto-post-split

on:
  # å¹³æ—¥ 09:00 JSTï¼ˆUTC 00:00ï¼‰
  schedule:
    - cron: '0 0 * * 1-5'
    # å¹³æ—¥ 18:00 JSTï¼ˆUTC 09:00ï¼‰
    - cron: '0 9 * * 1-5'
    # é€±æœ« 10:00 JSTï¼ˆUTC 01:00ï¼‰
    - cron: '0 1 * * 6,0'
  workflow_dispatch:
    inputs:
      to:
        description: 'æŠ•ç¨¿å…ˆï¼ˆç©ºãªã‚‰ãƒãƒˆãƒªã‚¯ã‚¹å…¨å®Ÿè¡Œï¼‰'
        required: false
        default: ''
        type: choice
        options: ['', bluesky, mastodon]
      message:
        description: 'æŠ•ç¨¿æœ¬æ–‡ï¼ˆç©ºãªã‚‰è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰'
        required: false
        default: ''
      image:
        description: 'ç”»åƒURLï¼ˆZapierå´ãŒURLå—å–å¯¾å¿œã®å ´åˆï¼‰'
        required: false
        default: ''
      dateprefix:
        description: 'æ–‡é ­ã«æ—¥ä»˜ï¼ˆJSTï¼‰ã‚’ä»˜ä¸'
        required: false
        default: true
        type: boolean
      hashtags:
        description: 'ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š: wanstage,test ã®ã‚ˆã†ã«'
        required: false
        default: ''

env:
  TEMPLATE_MORNING: 'â˜€ï¸ æœã‚¤ãƒé€Ÿå ±ï¼WANSTAGEãŒä»Šæ—¥ã‚‚å‹•ãå‡ºã™ğŸš€ #ãŠã¯ã‚ˆã† #WANSTAGE'
  TEMPLATE_EVENING: 'ğŸŒ™ 1æ—¥ã®ç· ã‚ããã‚Šâœ¨ WANSTAGEæœ€æ–°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ğŸ‘€ #å¤œæ´» #WANSTAGE'
  TEMPLATE_WEEKEND: 'ğŸ‰ é€±æœ«é™å®šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼†è£è©±å…¬é–‹ä¸­ğŸ”¥ WANSTAGEã§ç››ã‚Šä¸ŠãŒã‚ã†ï¼ #é€±æœ«é™å®š #WANSTAGE'

jobs:
  post:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        to: [bluesky, mastodon]
    # æ‰‹å‹•æ™‚: toæœªæŒ‡å®šãªã‚‰ä¸¡æ–¹ / æŒ‡å®šæ™‚ã¯ä¸€è‡´ã®ã¿
    if: ${{ github.event.inputs.to == '' || github.event.inputs.to == matrix.to }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - run: npm ci

      - name: Derive slot label
        id: slot
        shell: bash
        run: |
          H=$(date -u +'%H')
          DOW=$(date -u +'%u') # 1..7 (Mon..Sun)
          # JST 09:00 = UTC 00:00ã€JST 18:00 = UTC 09:00ã€JST åœŸæ—¥10:00 = UTC 01:00
          if [[ "$DOW" -ge 1 && "$DOW" -le 5 && "$H" == "00" ]]; then
            echo "slot=wk-0900" >> $GITHUB_OUTPUT
          elif [[ "$DOW" -ge 1 && "$DOW" -le 5 && "$H" == "09" ]]; then
            echo "slot=wk-1800" >> $GITHUB_OUTPUT
          elif [[ "$DOW" -eq 6 || "$DOW" -eq 7 ]] && [[ "$H" == "01" ]]; then
            echo "slot=we-1000" >> $GITHUB_OUTPUT
          else
            echo "slot=manual" >> $GITHUB_OUTPUT
          fi

      - name: Post via Zapier relay
        env:
          ZAPIER_HOOK_URL: ${{ secrets.ZAPIER_HOOK_URL }}
          DEFAULT_HASHTAGS: ${{ vars.DEFAULT_HASHTAGS }}
          PROMO_URL: ${{ vars.PROMO_URL }}
        shell: bash
        run: |
          set -euo pipefail

          # 1) ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆï¼ˆå…¥åŠ›ãŒç©ºãªã‚‰æ™‚é–“å¸¯ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠï¼‰
          MSG="${{ github.event.inputs.message }}"
          if [ -z "$MSG" ]; then
            HOUR=$(date -u +"%H")
            DOW=$(date -u +"%u")
            if [ "$DOW" -ge 6 ]; then MSG="$TEMPLATE_WEEKEND";
            elif [ "$HOUR" -lt 9 ]; then MSG="$TEMPLATE_MORNING";
            else MSG="$TEMPLATE_EVENING"; fi
          fi

          # ã‚¹ãƒ­ãƒƒãƒˆã«å¿œã˜ã¦è¦‹å‡ºã—
          if [ -z "${{ github.event.inputs.message }}" ]; then
            case "${{ steps.slot.outputs.slot }}" in
              wk-0900) PREFIX="ã€æœã®æ›´æ–°ã€‘" ;;
              wk-1800) PREFIX="ã€å¤•æ–¹ã®æ›´æ–°ã€‘" ;;
              we-1000) PREFIX="ã€é€±æœ«ã®æ›´æ–°ã€‘" ;;
              *)       PREFIX="" ;;
            esac
            MSG="${PREFIX} ${MSG}"
          fi

          # 2) ä»˜ä¸è¦ç´ ï¼ˆprefix / ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚° / ç”»åƒï¼‰
          ARGS="--to=${{ matrix.to }}"
          if [ -n "${{ github.event.inputs.video_name }}" ]; then
            ARGS="$ARGS --video-name=${{ github.event.inputs.video_name }}";
          fi
          if [ -n "${{ github.event.inputs.video_name }}" ]; then
            ARGS="$ARGS --video-name=${{ github.event.inputs.video_name }}";
          fi
          if [ "${{ github.event.inputs.dateprefix }}" = "true" ]; then
            ARGS="$ARGS --dateprefix"
          fi

          # åç›Šå°ç·š: ãƒ—ãƒ­ãƒ¢URLï¼ˆã‚ã‚Œã°æœ«å°¾ä»˜ä¸ï¼‰
          if [ -n "${PROMO_URL:-}" ]; then
            MSG="$MSG ${PROMO_URL}"
          fi

          if [ -n "${{ github.event.inputs.hashtags }}" ]; then
            ARGS="$ARGS --hashtags=${{ github.event.inputs.hashtags }}"
          elif [ -n "${DEFAULT_HASHTAGS:-}" ]; then
            ARGS="$ARGS --hashtags=${DEFAULT_HASHTAGS}"
          fi

          if [ -n "${{ github.event.inputs.image }}" ]; then
            ARGS="$ARGS --image=${{ github.event.inputs.image }}"
          fi

          echo "node --no-warnings --experimental-strip-types ./src/post.ts $ARGS \"$MSG\""
          node --no-warnings --experimental-strip-types ./src/post.ts $ARGS "$MSG"
